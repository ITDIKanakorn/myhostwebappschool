<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฟอร์มแก้ไขข้อมูล รายวิชา</title>
    <link rel="stylesheet" href="../path/to/your/bootstrap.min.css">
    <link rel="stylesheet" href="../path/to/your/fontawesome.min.css">
    <link rel="stylesheet" href="../path/to/your/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <!-- Add SweetAlert2 -->
    
    <script>
        function validateForm() {
    // Get all input elements
    const inputs = document.querySelectorAll('input[type="text"], input[type="number"]');
    for (let input of inputs) {
        // Trim whitespace
        if (input.value.trim() === '') {
            input.focus(); // Set focus on the first empty field
            return false; // Prevent form submission
        }
    }
    return true; // Allow form submission
}

    </script>
</head>

<body>
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>ฟอร์มแก้ไขข้อมูล รายวิชา</h1>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="row">
                <div class="col-md-12">
                    <div class="card card-outline card-info">
                        <div class="card-body">
                            <div class="card card-primary">
                                <!-- /.card-header -->
                                <!-- form start -->
                                <form action="subject_edit.php" method="post" onsubmit="return validateForm()">
                                    <div class="card-body">
                                        <?php
require_once '../config/connect.php';

$subject_id = '';
$subject_name = '';
$num_credits = '';
$total_class_hours = '';
$theory_hours = '';
$hours_of_practice = '';
$course_registration_fee = '';
$practice_fee = '';
$subjects_that_must_be_passed = '';
$major_id = '';
$semester = '';
$school_year = '';

// Check if subject_id is set in the query parameter
if (isset($_GET['subject_id'])) {
    $subject_id = $_GET['subject_id'];

    // Fetch subject data
    $stmt = $condb->prepare("SELECT * FROM subject WHERE subject_id = :subject_id");
    $stmt->bindParam(':subject_id', $subject_id, PDO::PARAM_STR);
    $stmt->execute();
    $subject = $stmt->fetch(PDO::FETCH_ASSOC);

    if ($subject) {
        $subject_name = $subject['subject_name'];
        $num_credits = $subject['num_credits'];
        $total_class_hours = $subject['total_class_hours'];
        $theory_hours = $subject['theory_hours'];
        $hours_of_practice = $subject['hours_of_practice'];
        $course_registration_fee = $subject['course_registration_fee'];
        $practice_fee = $subject['practice_fee'];
        $subjects_that_must_be_passed = $subject['subjects_that_must_be_passed'];
        $major_id = $subject['major_id'];
        $semester = $subject['semester']; // New field
        $school_year = $subject['school_year']; // New field
    
    } else {
        echo "<script>
            Swal.fire({
                title: 'ผิดพลาด!',
                text: 'ไม่พบข้อมูลวิชา',
                icon: 'error',
                confirmButtonText: 'ตกลง'
            }).then(() => {
                window.location.href = 'subject.php';
            });
            </script>";
    }
} else {
    echo "<script>
        Swal.fire({
            title: 'ผิดพลาด!',
            text: 'ไม่มีรหัสวิชา',
            icon: 'error',
            confirmButtonText: 'ตกลง'
        }).then(() => {
            window.location.href = 'subject.php';
        });
        </script>";
}
?>

                                        <input type="hidden" name="subject_id"
                                            value="<?= htmlspecialchars($subject_id) ?>">
                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">ชื่อวิชา</label>
                                            <div class="col-sm-4">
                                                <input type="text" name="subject_name" class="form-control"
                                                    value="<?= htmlspecialchars($subject_name) ?>" required
                                                    placeholder="ชื่อวิชา">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">หน่วยกิต</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="num_credits" class="form-control"
                                                    value="<?= htmlspecialchars($num_credits) ?>" required
                                                    placeholder="หน่วยกิต" min="1">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">ชั่วโมงเรียนทั้งหมด</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="total_class_hours" class="form-control"
                                                    value="<?= htmlspecialchars($total_class_hours) ?>" required
                                                    placeholder="ชั่วโมงเรียนทั้งหมด" min="1">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">ชั่วโมงทฤษฎี</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="theory_hours" class="form-control"
                                                    value="<?= htmlspecialchars($theory_hours) ?>" required
                                                    placeholder="ชั่วโมงทฤษฎี" min="0">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">ชั่วโมงปฏิบัติ</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="hours_of_practice" class="form-control"
                                                    value="<?= htmlspecialchars($hours_of_practice) ?>" required
                                                    placeholder="ชั่วโมงปฏิบัติ" min="0">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">ค่าลงทะเบียน</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="course_registration_fee" class="form-control"
                                                    value="<?= htmlspecialchars($course_registration_fee) ?>" required
                                                    placeholder="ค่าลงทะเบียน" min="0">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">ค่าปฏิบัติ</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="practice_fee" class="form-control"
                                                    value="<?= htmlspecialchars($practice_fee) ?>" required
                                                    placeholder="ค่าปฏิบัติ" min="0">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">วิชาที่ต้องผ่าน</label>
                                            <div class="col-sm-4">
                                                <input type="text" name="subjects_that_must_be_passed"
                                                    class="form-control"
                                                    value="<?= htmlspecialchars($subjects_that_must_be_passed) ?>"
                                                    placeholder="วิชาที่ต้องผ่าน">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">รหัสหลักสูตร</label>
                                            <div class="col-sm-4">
                                                <input type="text" name="major_id" class="form-control"
                                                    value="<?= htmlspecialchars($major_id) ?>"
                                                    placeholder="รหัสหลักสูตร">
                                            </div>
                                        </div>
                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">ภาคเรียน</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="semester" class="form-control"
                                                    value="<?= htmlspecialchars($semester) ?>" required
                                                    placeholder="ภาคเรียน" min="1" max="3">
                                            </div>
                                        </div>

                                        <div class="form-group row">
                                            <label class="col-sm-2 col-form-label">ปีการศึกษา</label>
                                            <div class="col-sm-4">
                                                <input type="number" name="school_year" class="form-control"
                                                    value="<?= htmlspecialchars($school_year) ?>" required
                                                    placeholder="ปีการศึกษา" min="2000">
                                            </div>
                                        </div>


                                        <div class="form-group row">
                                            <div class="col-sm-2"></div>
                                            <div class="col-sm-4">
                                                <button type="submit" class="btn btn-primary">อัปเดตข้อมูล</button>
                                                <a href="subject.php" class="btn btn-danger">ยกเลิก</a>
                                            </div>
                                        </div>
                                    </div><!-- /.card-body -->
                                </form>

                                <?php
                                    if ($_SERVER["REQUEST_METHOD"] == "POST") {
                                        if (isset($_POST['subject_id']) && isset($_POST['subject_name']) && isset($_POST['num_credits']) && isset($_POST['total_class_hours']) && isset($_POST['theory_hours']) && isset($_POST['hours_of_practice']) && isset($_POST['course_registration_fee']) && isset($_POST['practice_fee']) && isset($_POST['subjects_that_must_be_passed']) && isset($_POST['major_id'])&& isset($_POST['semester'])&& isset($_POST['school_year'])) {
                                            $subject_id = $_POST['subject_id'];
                                            $subject_name = $_POST['subject_name'];
                                            $num_credits = $_POST['num_credits'];
                                            $total_class_hours = $_POST['total_class_hours'];
                                            $theory_hours = $_POST['theory_hours'];
                                            $hours_of_practice = $_POST['hours_of_practice'];
                                            $course_registration_fee = $_POST['course_registration_fee'];
                                            $practice_fee = $_POST['practice_fee'];
                                            $subjects_that_must_be_passed = $_POST['subjects_that_must_be_passed'];
                                            $major_id = $_POST['major_id'];
                                            $semester = $_POST['semester'];
                                            $school_year = $_POST['school_year'];

                                            if (!empty($subject_id) && !empty($subject_name) && !empty($num_credits) && !empty($total_class_hours) && !empty($theory_hours) && !empty($hours_of_practice) && !empty($course_registration_fee) && !empty($practice_fee) && !empty($subjects_that_must_be_passed) && !empty($major_id)&& !empty($semester)&& !empty($school_year)) {
                                                require_once '../config/connect.php';

                                                $stmt = $condb->prepare("UPDATE subject SET subject_name = :subject_name, num_credits = :num_credits, total_class_hours = :total_class_hours, theory_hours = :theory_hours, hours_of_practice = :hours_of_practice, course_registration_fee = :course_registration_fee, practice_fee = :practice_fee, subjects_that_must_be_passed = :subjects_that_must_be_passed, major_id = :major_id, semester = :semester, school_year = :school_year WHERE subject_id = :subject_id");
                                                $stmt->bindParam(':subject_id', $subject_id, PDO::PARAM_STR);
                                                $stmt->bindParam(':subject_name', $subject_name, PDO::PARAM_STR);
                                                $stmt->bindParam(':num_credits', $num_credits, PDO::PARAM_INT);
                                                $stmt->bindParam(':total_class_hours', $total_class_hours, PDO::PARAM_INT);
                                                $stmt->bindParam(':theory_hours', $theory_hours, PDO::PARAM_INT);
                                                $stmt->bindParam(':hours_of_practice', $hours_of_practice, PDO::PARAM_INT);
                                                $stmt->bindParam(':course_registration_fee', $course_registration_fee, PDO::PARAM_INT);
                                                $stmt->bindParam(':practice_fee', $practice_fee, PDO::PARAM_INT);
                                                $stmt->bindParam(':subjects_that_must_be_passed', $subjects_that_must_be_passed, PDO::PARAM_STR);
                                                $stmt->bindParam(':major_id', $major_id, PDO::PARAM_STR);
                                                $stmt->bindParam(':semester', $semester, PDO::PARAM_STR);
                                                $stmt->bindParam(':school_year', $school_year, PDO::PARAM_STR);
                                                

                                                if ($stmt->execute()) {
                                                    echo "<script src='https://cdn.jsdelivr.net/npm/sweetalert2@11'></script>";
                                                    echo "<script>
                                                        Swal.fire({
                                                            title: 'สำเร็จ!',
                                                            text: 'อัปเดตข้อมูลวิชาเรียบร้อยแล้ว',
                                                            icon: 'success',
                                                            confirmButtonText: 'ตกลง'
                                                        }).then(() => {
                                                            window.location.href = 'subject.php';
                                                        });
                                                        </script>";
                                                } else {
                                                    echo "<script>
                                                        Swal.fire({
                                                            title: 'ผิดพลาด!',
                                                            text: 'ไม่สามารถอัปเดตข้อมูลวิชาได้',
                                                            icon: 'error',
                                                            confirmButtonText: 'ตกลง'
                                                        }).then(() => {
                                                            window.location.href = 'subject.php';
                                                        });
                                                        </script>";
                                                }
                                            } else {
                                                echo "<script>
                                                    Swal.fire({
                                                        title: 'ผิดพลาด!',
                                                        text: 'กรุณากรอกข้อมูลให้ครบถ้วน',
                                                        icon: 'warning',
                                                        confirmButtonText: 'ตกลง'
                                                    }).then(() => {
                                                        window.location.href = 'subject.php';
                                                    });
                                                    </script>";
                                            }
                                        } else {
                                            echo "<script>
                                                Swal.fire({
                                                    title: 'ผิดพลาด!',
                                                    text: 'ข้อมูลไม่ครบถ้วน',
                                                    icon: 'warning',
                                                    confirmButtonText: 'ตกลง'
                                                }).then(() => {
                                                    window.location.href = 'subject.php';
                                                });
                                                </script>";
                                        }
                                    }
                                ?>

                            </div><!-- /.card -->
                        </div>
                    </div>
                </div>
            </div>
        </section><!-- /.content -->
    </div><!-- /.content-wrapper -->
</body>

</html>
