<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ฟอร์มเพิ่มข้อมูลแผนการเรียน</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <!-- Custom CSS -->
    <style>
    .card-header {
        background-color: #007bff;
        color: #fff;
    }

    .btn-info {
        background-color: #17a2b8;
        border-color: #17a2b8;
    }

    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }

    .advice-card {
        border-color: #007bff;
        border-radius: 0.5rem;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    .advice-card .card-header {
        background-color: #6c757d;
        color: #fff;
    }

    .btn-fetch-data {
        background-color: #004d40;
        /* Dark greenish-blue color */
        border-color: #004d40;
        color: #fff;
        /* White text */
    }

    .btn-fetch-data:hover {
        background-color: #00332d;
        /* Darker shade for hover */
        border-color: #00332d;
    }
    </style>
</head>

<body>
    <!-- Content Wrapper -->
    <div class="content-wrapper">
        <!-- Content Header -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <h1>ฟอร์มเพิ่มข้อมูลแผนการเรียน</h1>
                    </div>
                </div>
            </div>
        </section>

        <!-- Main Content -->
        <section class="content">
            <div class="row justify-content-center">
                <div class="col-md-10">
                    <div class="card card-outline card-info">
                        <div class="card-body">
                            <div class="row">
                                <!-- Main Form -->
                                <div class="col-md-8">
                                    <form action="" method="post" id="studyPlanForm">
                                        <div class="card-body">
                                            <!-- Subject ID -->
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">รหัสวิชา</label>
                                                <div class="col-sm-9">
                                                    <div class="input-group">
                                                        <input type="text" name="subject_id" class="form-control"
                                                            required placeholder="รหัสวิชา">
                                                        <div class="input-group-append">
                                                            <button type="button"
                                                                class="btn btn-fetch-data">ดึงข้อมูล</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Major ID -->
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">รหัสสาขา</label>
                                                <div class="col-sm-9">
                                                    <input type="text" name="major_id" class="form-control" required
                                                        placeholder="รหัสสาขา">
                                                </div>
                                            </div>

                                            <!-- Subject Name -->
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">ชื่อวิชา</label>
                                                <div class="col-sm-9">
                                                    <input type="text" name="study_plan_name" class="form-control"
                                                        required placeholder="ชื่อวิชา">
                                                </div>
                                            </div>

                                            <!-- Number of Credits -->
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">หน่วยกิต</label>
                                                <div class="col-sm-9">
                                                    <input type="number" name="num_credits" class="form-control"
                                                        required placeholder="หน่วยกิต">
                                                </div>
                                            </div>

                                            <!-- Total Class Hours -->
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">รวมชั่วโมง</label>
                                                <div class="col-sm-9">
                                                    <input type="number" name="total_class_hours" class="form-control"
                                                        required placeholder="รวมชั่วโมง">
                                                </div>
                                            </div>

                                            <!-- Theory Hours -->
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">ชั่วโมงทฤษฎี</label>
                                                <div class="col-sm-9">
                                                    <input type="number" name="theory_hours" class="form-control"
                                                        required placeholder="ชั่วโมงทฤษฎี">
                                                </div>
                                            </div>

                                            <!-- Practice Hours -->
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">ชั่วโมงปฏิบัติ</label>
                                                <div class="col-sm-9">
                                                    <input type="number" name="hours_of_practice" class="form-control"
                                                        required placeholder="ชั่วโมงปฏิบัติ">
                                                </div>
                                            </div>

                                            <!-- School Year -->
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">ปีการศึกษา</label>
                                                <div class="col-sm-9">
                                                    <input type="text" name="school_year" class="form-control" required
                                                        placeholder="ปีการศึกษา">
                                                </div>
                                            </div>
                                            <!-- Semester -->
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">ภาคการศึกษา</label>
                                                <div class="col-sm-9">
                                                    <input type="text" name="semester" class="form-control" required
                                                        placeholder="ภาคการศึกษา">
                                                </div>
                                            </div>
                                            <!-- Class Year -->
                                            <div class="form-group row">
                                                <label class="col-sm-3 col-form-label">ชั้นปี</label>
                                                <div class="col-sm-9">
                                                    <input type="text" name="class_year" class="form-control" required
                                                        placeholder="ชั้นปี">
                                                </div>
                                            </div>
                                            <!-- Submit and Cancel Buttons -->
                                            <div class="form-group row">
                                                <div class="col-sm-12 text-right">
                                                    <button type="submit" class="btn btn-info">บันทึกข้อมูล</button>
                                                    <a href="studyplan.php" class="btn btn-danger">ยกเลิก</a>
                                                </div>
                                            </div>
                                        </div><!-- /.card-body -->
                                    </form>
                                </div><!-- /.col-md-8 -->

                                <!-- Advice Card -->
                                <div class="col-md-4">
                                    <div class="card advice-card">
                                        <div class="card-header">
                                            <h4 class="card-title">คำแนะนำในการเพิ่มข้อมูลแผนการเรียน</h4>
                                        </div>
                                        <div class="card-body">
                                            <ul>
                                                <li>กรุณากรอกรหัสวิชาที่ถูกต้องตามหลักเกณฑ์ที่กำหนดไว้</li>
                                                <li>ระบุรหัสสาขาวิชาที่ข้อมูลนี้เกี่ยวข้อง</li>
                                                <li>กรอกปีการศึกษาที่ต้องการเพิ่มข้อมูล</li>
                                                <li>เลือกภาคการศึกษาที่ข้อมูลจะถูกบันทึก</li>
                                                <li>ระบุชั้นปีที่ข้อมูลนี้ใช้</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div><!-- /.col-md-4 -->
                            </div><!-- /.row -->
                        </div><!-- /.card-body -->
                    </div><!-- /.card -->
                </div><!-- /.col-md-10 -->
            </div><!-- /.row -->
        </section><!-- /.content -->
    </div><!-- /.content-wrapper -->
    <!-- PHP to Insert Study Plan Data -->
    <?php
    if ($_SERVER['REQUEST_METHOD'] === 'POST') {
        if (isset($_POST['subject_id'], $_POST['major_id'], $_POST['school_year'], $_POST['semester'], $_POST['class_year'])) {
            require_once '../config/connect.php';

            // รับค่าจากฟอร์มและทำการ sanitize ข้อมูล
            $subject_id = htmlspecialchars(trim($_POST['subject_id']));
            $major_id = htmlspecialchars(trim($_POST['major_id']));
            $school_year = htmlspecialchars(trim($_POST['school_year']));
            $semester = htmlspecialchars(trim($_POST['semester']));
            $class_year = htmlspecialchars(trim($_POST['class_year']));

            try {
                // เริ่ม transaction
                $condb->beginTransaction();

                // เตรียมคำสั่ง SQL สำหรับเพิ่มข้อมูล
                $stmtInsertPlan = $condb->prepare("INSERT INTO subject (subject_id, major_id, school_year, semester, class_year) VALUES (:subject_id, :major_id, :school_year, :semester, :class_year)");

                // ผูกค่าที่จะเพิ่มลงในฐานข้อมูล
                $stmtInsertPlan->bindParam(':subject_id', $subject_id);
                $stmtInsertPlan->bindParam(':major_id', $major_id);
                $stmtInsertPlan->bindParam(':school_year', $school_year);
                $stmtInsertPlan->bindParam(':semester', $semester);
                $stmtInsertPlan->bindParam(':class_year', $class_year);

                // ดำเนินการเพิ่มข้อมูล
                if ($stmtInsertPlan->execute()) {
                    // ยืนยันการเพิ่มข้อมูล
                    $condb->commit();
                    echo '<script>
                        Swal.fire({
                            icon: "success",
                            title: "เพิ่มข้อมูลสำเร็จ",
                            text: "ข้อมูลแผนการเรียนได้ถูกเพิ่มเรียบร้อยแล้ว!",
                            confirmButtonText: "ตกลง"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = "study_plan.php";
                            }
                        });
                        </script>';
                }
            } catch (PDOException $e) {
                // ยกเลิก transaction หากเกิดข้อผิดพลาด
                $condb->rollBack();
                echo '<script>
                    Swal.fire({
                        icon: "error",
                        title: "ข้อผิดพลาด",
                        text: "เกิดข้อผิดพลาด: ' . $e->getMessage() . '",
                        confirmButtonText: "ตกลง"
                    });
                    </script>';
            }
        }
    }
    ?>
    <!-- Bootstrap and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- SweetAlert2 JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

    <script>
    $(document).ready(function() {
        $('.btn-fetch-data').click(function() {
            var subject_id = $('input[name="subject_id"]').val();
            if (subject_id) {
                $.ajax({
                    url: 'fetch_subject_data.php',
                    type: 'POST',
                    data: { subject_id: subject_id },
                    dataType: 'json',
                    success: function(response) {
                        if (response.success) {
                            // Populate the form fields with the returned data
                            $('input[name="major_id"]').val(response.data.major_id);
                            $('input[name="study_plan_name"]').val(response.data.subject_name);
                            $('input[name="num_credits"]').val(response.data.num_credits);
                            $('input[name="total_class_hours"]').val(response.data.total_class_hours);
                            $('input[name="theory_hours"]').val(response.data.theory_hours);
                            $('input[name="hours_of_practice"]').val(response.data.hours_of_practice);
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'ไม่พบข้อมูล',
                                text: response.message,
                                confirmButtonText: 'ตกลง'
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'เกิดข้อผิดพลาด',
                            text: 'ไม่สามารถดึงข้อมูลได้',
                            confirmButtonText: 'ตกลง'
                        });
                    }
                });
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'กรุณากรอกรหัสวิชา',
                    confirmButtonText: 'ตกลง'
                });
            }
        });
    });
</script>

</body>

</html>
